FROM php:alpine

ARG TWITCH_CHANNEL_NAME
ARG TWITCH_CLIENT_ID
ARG TWITCH_SECRET
ARG GOOGLE_APPLICATION_CREDENTIALS
ARG YOUTUBE_CHANNEL_ID
ARG YOUTUBE_CATEGORY_ID
ARG YOUTUBE_PLAYLIST_ID
ARG YOUTUBE_REFRESH_TOKEN
ARG MAIL_PROTOCOL
ARG MAIL_USERNAME
ARG MAIL_PASSWORD
ARG MAIL_HOST
ARG MAIL_PORT
ARG MAIL_FROM
ARG MAIL_TO

ENV TWITCH_CHANNEL_NAME=${TWITCH_CHANNEL_NAME}
ENV TWITCH_CLIENT_ID=${TWITCH_CLIENT_ID}
ENV TWITCH_SECRET=${TWITCH_SECRET}
ENV GOOGLE_APPLICATION_CREDENTIALS=${GOOGLE_APPLICATION_CREDENTIALS}
ENV YOUTUBE_CHANNEL_ID=${YOUTUBE_CHANNEL_ID}
ENV YOUTUBE_CATEGORY_ID=${YOUTUBE_CATEGORY_ID}
ENV YOUTUBE_PLAYLIST_ID=${YOUTUBE_PLAYLIST_ID}
ENV YOUTUBE_REFRESH_TOKEN=${YOUTUBE_REFRESH_TOKEN}
ENV MAIL_PROTOCOL=${MAIL_PROTOCOL}
ENV MAIL_USERNAME=${MAIL_USERNAME}
ENV MAIL_PASSWORD=${MAIL_PASSWORD}
ENV MAIL_HOST=${MAIL_HOST}
ENV MAIL_PORT=${MAIL_PORT}
ENV MAIL_FROM=${MAIL_FROM}
ENV MAIL_TO=${MAIL_TO}

RUN apk update && apk add --no-cache python3 ffmpeg tzdata

RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

COPY --from=mlocati/php-extension-installer /usr/bin/install-php-extensions ./ipe

RUN ./ipe pcntl

RUN rm ./ipe

WORKDIR /app

COPY . .

COPY --from=composer /usr/bin/composer /usr/local/bin/composer

RUN composer install

RUN rm /usr/local/bin/composer

RUN touch /var/log/cron.log

RUN crontab ./crontab

CMD ["/usr/sbin/crond", "-f", "-d", "0"]
